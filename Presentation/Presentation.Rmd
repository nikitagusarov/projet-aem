---
title: "Etude des effets des pésticides dans la production des vins de table"
subtitle: "Analyse empirique des marchés"
author: A. Blanc, N. Gusarov, S. Picon
institute: Université Grenoble Alpes
date: 11/12/2019
header-includes:
    - \usepackage{array}
    - \usepackage{multicol}
output: 
    beamer_presentation:
        theme: "Montpellier"
        colortheme: "beaver"
        # fonttheme: "structurebold"
        toc: TRUE
        # toc_depth: 2
        df_print: "kable"
        fig_width: 4
        fig_height: 3
        fig_caption: true
fontsize: 11pt
# geometry: margin = 0.5in
---

```{r include = FALSE}
###################
# Setting r options
###################
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(size = "tiny")
```

```{r include = FALSE}
##########
# Packages
##########
require(tidyverse)
require(plm)
require(Formula)
require(gridExtra)
require(stargazer)
require(texreg)
require(rlang)
require(dummies)
```

```{r include = FALSE}
##############
# Loading data
##############
# Data
data = read.csv("../Donnees/Base-de-donnees-indice-prix.csv")
# names(data)
# Arrange
dn = data %>%
    filter(s_vin_simple != 0 & 
        (q_rouge + q_blanc) != 0 &
        (qk_prod + ql_prod) != 0 &
        IP != 0) %>%
    na.omit() %>%
    group_by(ndep) %>%
    count() %>% 
    filter(n == 5) # %>%
    # select(ndep)
datax = data %>% 
    filter(ndep %in% dn$ndep) 
datay = datax %>% 
    filter(annee == 2012) %>%
    mutate(refqki = qk_prod + ql_prod) %>% 
    select(ndep, refqki) 
datax = left_join(datax, datay)
datax = datax %>%
    mutate(IQK = (qk_prod + ql_prod)/refqki)
```

```{r include = FALSE}
##################
# Transformed data
##################
datai = datax %>%
    arrange(ndep) %>%
    mutate(si = log(s_vin_simple + 0.001), 
        qi = log(q_blanc + q_rouge + 0.001), 
        ipi = log(IP),
        ri = log(revenu.déflaté),
        iki = log(IQK),
        t = as.integer(as.factor(annee)),
        year = annee) %>%
    dplyr::select(year, ndep, qi, ipi, si, ri, iki, t)
```

```{r include = FALSE}
############
# Panel data
############
datap = pdata.frame(datai, index = c("ndep", "year"),
    drop.index = T)
```

```{r include = FALSE}
#################
# Clear workplace
#################
list = ls()
keep = c("datai", "datap")
omit = setdiff(list, keep)
rm(omit)
```

```{r include = FALSE}
###################
# Support functions
###################
# xtsum (overall, within and between variance) for panel data
# STATA version
xtsum = function(data, varname, unit) {
    # the variable to xtsum over
    varname = enquo(varname)
    # the identifier dimention
    loc.unit = enquo(unit)
    # overall
    ores = data %>% 
        summarise(ovr.mean = mean(!! varname, na.rm = TRUE), 
        ovr.sd = sd(!! varname, na.rm = TRUE), 
        ovr.min = min(!! varname, na.rm = TRUE), 
        ovr.max = max(!! varname, na.rm = TRUE), 
        ovr.N = sum(as.numeric((!is.na(!! varname)))))
    # between
    bmeans = data %>% 
        group_by(!! loc.unit) %>% 
        summarise(meanx = mean(!! varname, na.rm = TRUE), 
        t.count = sum(as.numeric(!is.na(!! varname))))
    bres = bmeans %>% 
        ungroup() %>% 
        summarise(between.sd = sd(meanx, na.rm = TRUE), 
        between.min = min(meanx, na.rm = TRUE), 
        between.max = max(meanx, na.rm = TRUE), 
        units = sum(as.numeric(!is.na(t.count))), 
        t.bar = mean(t.count, na.rm = TRUE))
    # within
    wdat = data %>% 
        group_by(!! loc.unit) %>% 
        mutate(W.x = scale(!! varname, scale = FALSE))
    wres = wdat %>% 
        ungroup() %>%  
        summarise(within.sd = sd(W.x, na.rm = TRUE), 
        within.min = min(W.x, na.rm = TRUE), 
        within.max = max(W.x, na.rm = TRUE))
    # results
    return(list(var = varname, ores = ores, bres = bres, wres = wres))
}
# Print results for a list of xtsums
print.xtsum = function(xtsums.list) {
    # takes multiple xtsums as list
    df = data.frame(Variable = NA, Mean = NA,
        Overall = NA, Between = NA, Within = NA)
    # Filling loop
    for (i in 1:length(xtsums.list)) {
        df[i,1] = as_name(xtsums.list[[i]]$var)
        df[i,2] = xtsums.list[[i]]$ores$ovr.mean 
        df[i,3] = xtsums.list[[i]]$ores$ovr.sd
        df[i,4] = xtsums.list[[i]]$bres$between.sd
        df[i,5] = xtsums.list[[i]]$wres$within.sd
    }
    # Rownames
    rownames(df) = df[,1]
    # Results
    return(df = df[,-1])
}
```

```{r include = FALSE}
##################
# Set ggplot style
##################
pres_theme = theme(text = element_text(size = rel(3)),
    legend.position = "none")
```

```{r include = FALSE}
#################
# Effects testing 
#################
Effect.testing = function(Formulas, data) {
    Dtest = data.frame(var = 0,
        Random = 0, Fixed = 0, 
        Individual = 0, Time = 0, Twoways = 0)
        for (i in 1:length(Formulas)) {
            Dtest[i,1] = names(Formulas)[i]
            ## Chow test
            # Random coefs for random effects          
            Dtest[i,2] = pooltest(Formulas[[i]],
                data = data,
                model = "random")$p.val 
            # Different coefs for fixed effects
            Dtest[i,3] = pooltest(Formulas[[i]],
                data = data,
                model = "within")$p.val
            ## Lagrange multiplier tests
            # Individual effects
            Dtest[i,4] = plmtest(Formulas[[i]],
                data = data,
                effect = "individual",
                type = "bp")$p.val
            # Time effects
            Dtest[i,5] = plmtest(Formulas[[i]],
                data = data,
                effect = "time",
                type = "bp")$p.val
            # Two-ways effects (individual and time)
            Dtest[i,6] = plmtest(Formulas[[i]],
                data = data,
                effect = "twoways",
                type = "ghm")$p.val   
        }
    rownames(Dtest) = Dtest[,1]
    return(Dtest = Dtest[,-1])
}
```

# Introduction
Dans cet étude, nous chercherons à étudier l'équilibre sur le marché du vin. 

Nous chercherons à répondre à la question suivante :

- Quel est l'effet de la demande de pesticide sur l'équilibre des vins simples ?

# Plan de la présentation
- Présentation de la problématique
- Présentation des données
- Modélisation
- Les résultats

# Le problème des pesticides
- Présentation du problème des pésticides
- Etat actuel
- Comment combattre

# Présentation du problème des pesticides
- source de nombreux débats sur la santé et l'environnement
- plusieurs mesures mises en places pour réduire leurs usages :
    - interdiction des produits les plus toxiques ;
    - instauration d'une taxe (Butault et al, 2011).

- l'utilisation perdure:
    - hausse des ventes de produits phytosanitaires
    - Augmentation des doses utilisés : +12% en 2014-2016
    - moyen de protection contre les aléas climatiques 
    - préservation du rendement
  
# Etat actuel
Aucune baisse de l'utilisation de pesticides. 

- Nodu augmente de 23% entre 2008 et 2017
- Le nombre de substances actives utilisées a augmenté de 15% entre 2011 et 2017.
- Baisse des produits les plus dangereux de 6%, en 2017 (Moghaddam et al, 2019)
- Les grandes cultures (blés, etc...) sont les premières utilisatrices de pesticides 67.4%
- Les vignes sont les deuxièmes 14.4% (Butault et al, 2011)
    
# Comment baisser l'utilisation de pesticides
- le changement de mode de culture:
    - agriculture intensive -> agriculture biologique
    - agriculture raisonnée -> adapté la quantité de produit utilisé à la culture et à la surface
    - diminution des doses
    - déserherber un rang sur 2 dans les vignes puis désherbage mécanique
- la diversification des cultures (Moghaddam et al, 2019)

# Le marché du vin français
- Le marché commun
- Utilisation des pésticides dans viticulture
- Heterogénéité
- Pourquoi vins de table
- Le marché des vins de table français

# Le marché commun
Principal producteur de vin:

- 10% surface de vigne mondiale
- 20% terres agricoles française dédiées à la vigne
- 3% de la surface agricole est consacré au vin
- 16% de la production mondiale boisson alcoolisées la plus consommée en France
- 88% des ventes de vins en France sont effectuées dans une grande surface (le Comité National des Interprofessions des Vins à appelation d'origine et à indication géographique, 2018)

La consommation de vins (2011)(FranceAgrimer, 2011)

- 55% de vins rouges 
- 16% de vins blancs
- 29% de vins rosés 

La France est le premier exportateur de vin.
  
# Utilisation des pesticides dans viticulture
La viticulture un type de culture gourmand en pesticides :

- 14.4% des produits phytosanitaires utilisés en France.
- 2è culture utilisatrice de pesticides en Frances
- Les régions viticoles sont des régions ou les dépenses en phyto sont les plus importantes
- Fortes disparités d'utilisation des pesticides entre les régions.(climat) (Butault et al, 2011)
- Les bassins viticoles Français utilisent en majorité des fongicides et des bactéricides
- La champagne est la région la plus utilisatrice de pesticide avec un IFT de 21.4 en 2013.
- Les pyrennées orientales sont la région la moins utilisatrice de pesticide avec un IFT de 9.2 en 2013.(Pujol, J, 2017)
  
# Heterogénéité
Il existe une forte hétérogénéité entre les différents labels mais aussi à l'intérieur de ces labels. 

Les vins peuvent être divisés en 2 grandes classes suivant leurs prix(Cembalo et al., 2014) :

- les vins de qualité moyenne
    - ils ont un degré d'hétérogénéité important (Cembalo et al, 2014)

- les vins de qualité supérieure
    - limitation des quantités produites, 
    - une origine contrôlé 
    - une demande spécifique

# Pourquoi vins de table
Les vins de tables sont des vins sans indication géographiques

- hétérogènéité importante, 
- en moyenne prix bas.

Il s'agit des vins les plus simples, refusant les contraintes associées aux labels.

Nous traitons seulement des vins sans indication géographique.

- La situation sur ce marché influence l'utilisation des pesticides
- Les volumes de production sont plus significatifs dans le marché des vins sans indication géographique. 
- Il existe une homogénéité presque parfaite dans les vins sans indication géographique (Cembalo et al, 2014).

# Le marché des vins de tables Français :
Représente 10% de la production (VIN & SOCIETE, 2018)

- Hausse des transactions en 2011:
    - Vins rouges : 29 %
    - Vins rosés :13% 
    - Vins blancs : 76%

- Hausse des prix: 
    - Vins rouges : 12%
    - Vins rosés : 3%
    - Vins blancs : 13%

- La consommation des vins sans IG en 2011 :
    - baisse des ventes en grande distribution de 14.6%

# Le Modèle théorique
- Le rôle des pesticides dans la production du vin
- Le rôle de la demande sur la production et l'offre en général
- La formalisation et les équations

# Le rôle de la demande sur la production et l'offre en génèral
- Nous supposons que sur le marché des vins simples la demande est unique pour toute la France.
- La production de vin varie par département à cause de variations climatologiques
- On observe l'équilibre sur le marché au niveau du pays. Ainsi, la quantité demandée = quantité offerte par l'ensemble des régions.
- La demande de pesticides est inélastique au prix. Ainsi, la quantité de pesticides utilisée dépend seulement des intentions et des besoins des agriculteurs.

# Les données
Sources des données : 

- Les données de ventes de pesticides par département : Institut National de l'Environnement Industriel et des Risques (INERIS)
- Les données sur les prix du vin (France Agrimer)
- Les données sur la population (INSEE)
- Les données sur la production de vin (service statistique du ministère des Finances)
     
Base de données finale :

- une base de données en panel double dimention
- par départements français (en France Métropolitaine excepté la Corse)
- les années (2012 à 2016)
   
# Déscription des données :
- Toutes les variables varient par département et par année.
- Le période temporelle comprise dans notre échantillon est de 2012 à 2016 (nombre de périodes pauvres mais intérêt de disposer d'un panel cylindré)
- Sélection des régions productrices de vin et utilisatrices de pesticides : 69 départements.
- Elimination des effets fixes en soustrayant les moyennes départementales des quantités produites de vin.

# Les variables utilisées pour notre modèle :
- Variable d'intérêt : quantités totales de pesticides vendues par département 
- Variables dépendantes : la quantité totale produite de vin rouge et blanc non IG par département (en hectolitres), le prix moyen des vins rouges-blancs par département (représenté à l'aide d'un indice des prix du vin par département construit à partir des prix moyen nationaux des vins blancs et rouges)
- Variables de controle : revenu médian par département, surface agricole destinée à la culture viticole (en hectares)

# Les statistiques déscriptives
- Between and within variance par variable 
- Bivariate plots with support regressions
- Covariance analysis
- Fixed vs Random effects 

# Etude de la variance 
```{r include = FALSE}
lxtsums = list()
# list
lxtsums[[1]] = xtsum(datai, ipi, ndep)
lxtsums[[2]] = xtsum(datai, iki, ndep)
lxtsums[[3]] = xtsum(datai, si, ndep)
lxtsums[[4]] = xtsum(datai, ri, ndep)
lxtsums[[5]] = xtsum(datai, t, ndep)
# results
results = print.xtsum(lxtsums)
rownames(results) = c("Index prix", "Index pesticides",
    "Surface", "Revenus", "Temps")
```
```{r echo = FALSE, eval = FALSE}
stargazer(results, 
    title = "Variance study",
    summary = FALSE)
```
\tiny
\begin{table}[!htbp] \centering 
  \caption{Variance study}
\begin{tabular}{@{\extracolsep{5pt}} l|cccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & Mean & Overall & Between & Within \\ 
\hline \\[-1.8ex] 
Index prix & $0.175$ & $0.568$ & $0.368$ & $0.434$ \\ 
Index pesticides & $0.170$ & $0.333$ & $0.239$ & $0.234$ \\ 
Surface & $4.892$ & $1.986$ & $1.955$ & $0.410$ \\ 
Revenus & $9.891$ & $0.061$ & $0.061$ & $0.011$ \\ 
Temps & $3$ & $1.416$ & $0$ & $1.416$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table}

# Visualisatoin des interdependances
```{r echo = FALSE}
p1 = datai %>% 
    ggplot(aes(qi, ipi, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ IP") +
    xlab("Quantité du vin") + ylab("Index du prix") +
    pres_theme
p2 = datai %>% 
    ggplot(aes(qi, iki, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ IK") +
    xlab("Quantité du vin") + ylab("Index des pésticides") +
    pres_theme
grid.arrange(p1, p2, nrow = 1)
# Probably it is better to do it by variable
```

# Visualisatoin des interdependances
```{r echo = FALSE}
p1 = datai %>% 
    ggplot(aes(qi, si, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ S") +
    xlab("Quantité du vin") + ylab("Surface qultivé") +
    pres_theme
p2 = datai %>% 
    ggplot(aes(qi, ri, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ R") +
    xlab("Quantité du vin") + ylab("Revenus") +
    pres_theme
grid.arrange(p1, p2, nrow = 1)
```

# Random and fixed effects testing
- Poolability tests (tested versus pooled model) 
```{r include = FALSE}
Formulas = list(
    ipi = qi ~ ipi,
    iki = qi ~ iki,
    si = qi ~ si,
    ri = qi ~ ri)
Dtest = Effect.testing(Formulas, data = datap)
rownames(Dtest) = c("Index prix", "Index pesticides",
    "Surface", "Revenus")
```
```{r include = FALSE}
stargazer(Dtest[,c(1:2)], 
    title = "Chow pooling test, p-values",
    summary = FALSE)
```
\tiny
\begin{table}[!htbp] \centering
  \caption{Chow pooling test, p-values}
\begin{tabular}{@{\extracolsep{5pt}} l|cc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & Random & Fixed \\ 
\hline \\[-1.8ex] 
Index prix & $0.535$ & $0.533$ \\ 
Index pesticides & $0.485$ & $0.451$ \\ 
Surface & $0$ & $0.0001$ \\ 
Revenus & $0.297$ & $0.247$ \\ 
\hline \\[-1.8ex]
\end{tabular} 
\end{table} 

# Type of fixed effect testing
- Type of fixed effects testing
```{r include = FALSE}
stargazer(Dtest[,c(3:ncol(Dtest))], 
    title = "Lagrange multiplier test, p-values",
    summary = FALSE)
```
\tiny
\begin{table}[!htbp] \centering 
  \caption{Lagrange multiplier test, p-values}
\begin{tabular}{@{\extracolsep{5pt}} l|ccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & Individual & Time & Two-ways \\ 
\hline \\[-1.8ex] 
Index prix & $0$ & $0.169$ & $0$ \\ 
Index pesticides & $0$ & $0.222$ & $0$ \\ 
Surface & $0$ & $0.030$ & $0$ \\ 
Revenus & $0$ & $0.248$ & $0$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

# Correlation
```{r echo = FALSE}
correlation = cor(datap)
colnames(correlation) = c("Quantité du vin", "IP", 
        "Surface", "Revenus", 
        "Index pésticides", "Temps")
rownames(correlation) = c("Quantité du vin", "IP", 
        "Surface", "Revenus", 
        "Index pésticides", "Temps")
```
```{r include = FALSE}
stargazer(correlation, 
    title = "Overall correlation",
    summary = F)
```
\tiny
\begin{table}[!htbp] \centering
  \tiny\caption{Overall correlation}
\begin{tabular}{@{\extracolsep{5pt}} l|cccccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & Quantité du vin & IP & Surface & Revenus & Index pésticides & Temps \\
\hline \\[-1.8ex]
Quantité du vin & $1$ & $0.154$ & $0.956$ & $-0.027$ & $-0.078$ & $-0.036$ \\      
IP & $0.154$ & $1$ & $0.045$ & $-0.037$ & $-0.127$ & $0.043$ \\
Surface & $0.956$ & $0.045$ & $1$ & $-0.057$ & $-0.060$ & $-0.064$ \\
Revenus & $-0.027$ & $-0.037$ & $-0.057$ & $1$ & $-0.052$ & $0.119$ \\
Index pésticides & $-0.078$ & $-0.127$ & $-0.060$ & $-0.052$ & $1$ & $0.291$ \\  
Temps & $-0.036$ & $0.043$ & $-0.064$ & $0.119$ & $0.291$ & $1$ \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}

```{r include = FALSE}
###################
# Rework the matrix WITHIN_TRANSFORM
###################
rm(datax) ; rm(datay) ; rm(data) ; rm(dn)
dataW = datap 
dataW$qi = Within(datap$qi)
dataW$ipi = Within(datap$ipi)
dataW$iki = Within(datap$iki)
dataW$si = Within(datap$si)
dataW$ri = Within(datap$ri)
```
```{r include = FALSE}
correlationW = cor(dataW)
dataW$ndep = index(datap)$ndep
colnames(correlationW) = c("Quantité du vin", "IP", 
        "Surface", "Revenus", 
        "Index pésticides", "Temps")
rownames(correlationW) = c("Quantité du vin", "IP", 
        "Surface", "Revenus", 
        "Index pésticides", "Temps")
```
```{r include = FALSE}
stargazer(correlationW, 
    title = "Within transformation correlation",
    summary = F)
```
\tiny
\begin{table}[!htbp] \centering 
  \tiny\caption{Within transformation correlation}
\begin{tabular}{@{\extracolsep{5pt}} ccccccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & Quantité du vin & IP & Surface & Revenus & Index pésticides & Temps \\ 
\hline \\[-1.8ex] 
Quantité du vin & $1$ & $0.961$ & $0.366$ & $-0.160$ & $-0.228$ & $-0.199$ \\ 
IP & $0.961$ & $1$ & $0.289$ & $-0.009$ & $-0.127$ & $0.056$ \\ 
Surface & $0.366$ & $0.289$ & $1$ & $-0.166$ & $-0.191$ & $-0.310$ \\ 
Revenus & $-0.160$ & $-0.009$ & $-0.166$ & $1$ & $0.228$ & $0.652$ \\ 
Index pésticides & $-0.228$ & $-0.127$ & $-0.191$ & $0.228$ & $1$ & $0.414$ \\ 
Temps & $-0.199$ & $0.056$ & $-0.310$ & $0.652$ & $0.414$ & $1$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

# Within transformation results
```{r echo = FALSE}
p1 = dataW %>% 
    ggplot(aes(qi, ipi, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ IP") +
    xlab("Quantité du vin") + ylab("Index du prix") +
    pres_theme
p2 = dataW %>% 
    ggplot(aes(qi, iki, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ IK") +
    xlab("Quantité du vin") + ylab("Index des pésticides") +
    pres_theme
grid.arrange(p1, p2, nrow = 1)
# Probably it is better to do it by variable
```

# Within transformation results
```{r echo = FALSE}
p1 = dataW %>% 
    ggplot(aes(qi, si, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ S") +
    xlab("Quantité du vin") + ylab("Surface qultivé") +
    pres_theme
p2 = dataW %>% 
    ggplot(aes(qi, ri, col = as.factor(ndep))) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", se = F, size = 0.25) +
    # ggtitle("Q ~ R") +
    xlab("Quantité du vin") + ylab("Revenus") +
    pres_theme
grid.arrange(p1, p2, nrow = 1)
```

# Modèlisation
- Explication de la méthode utilisée
    - Panel data
        - Within transforation 
        - Fixed effects 
        - Obtained slopes are averages for all population 
    - AIDS model 
        - Interdependent equations (simultaneity bias)
        - 3SLS estimator (that is identical to ILS estimator)
        - It generates consistent estimates
        - The distribution of the estimators are normally distributed only in large samples 
        - The estimator is (asymptotically) efficient
- Limites du modèle 
    - Faible representation des effets hetérogenes entre les régions (nous estimons seulemnt les effets moyens)
    - Les interferences induites par l'heterogénéité 

```{r include = FALSE, eval = FALSE}
###################
# Not evaluated !!!
###################
###################
# Rework the matrix DUMMIES
###################
Dum = dummy(datai$ndep, sep = "_")
# Index pésticides
IKI = as.matrix(datai$iki)[, rep(1, each = length(unique(datai$ndep)))]
ikiDum = as.data.frame(Dum*IKI) %>% 
    setNames(paste0('iki_', names(.)))
rm(IKI)
# Revenus
RI = as.matrix(datai$ri)[, rep(1, each = length(unique(datai$ndep)))]
riDum = as.data.frame(Dum*RI) %>% 
    setNames(paste0('ri_', names(.)))
rm(RI)
# Concatenate
dataD = datai %>% 
    select(-c(t, ri, iki)) %>% 
    cbind(Dum) %>% 
    cbind(ikiDum) %>% 
    cbind(riDum)
```

```{r include = FALSE, eval = FALSE}
###################
# Not evaluated !!!
###################
###################
# Rework the matrix WITHINxDUMMIES
###################
Dum = dummy(datai$ndep, sep = "_")
# Index pésticides
IKI = as.data.frame(dataW$iki, ncol = 1)[, rep(1, each = length(unique(datai$ndep)))]
ikiDum = as.data.frame(Dum*IKI)
ikiDum = ikiDum %>%
    set_names(~str_replace_all(., "dataW\\$", ""))
rm(IKI)
# Revenus
RI = as.data.frame(dataW$ri)[, rep(1, each = length(unique(datai$ndep)))]
riDum = as.data.frame(Dum*RI) %>%
    rename_all(list(~str_replace_all(., "dataW\\$", "")))
rm(RI)
# Concatenate
dataWD = dataW %>% 
    select(-c(t, ri, iki)) %>% 
    cbind(ikiDum) %>% 
    cbind(riDum)
rm(ikiDum) ; rm(riDum)
```

# Résultats d'estimation
- Les coefficients estimés avec leurs variance 
- Etude des erreurs 
- Vérification des hypothèses (5 hypothèses) :
    - La moyenne nulle des erreurs 
    - Homoscedacité 
    - Autocorrélation 
    - Spécification du modèle 
    - ... (à voir)

# Les résultats OLS vs SUR
```{r include = FALSE}
# Data transformation for systemfit
dataWX = as.data.frame(dataW)
```

```{r include = FALSE}
# equations
eqdemand = qi ~ 0 + ipi + ri
eqoffer = qi ~ 0 + ipi + si + iki 
system = list(Demande = eqdemand, Offre = eqoffer)
# OLS
ols = systemfit(system, 
    data = dataWX, 
    method = "OLS")
# WLS
wls = systemfit(system, 
    data = dataWX, 
    method = "WLS")
# SUR
sur = systemfit(system, 
    data = dataWX, 
    method = "SUR")
```
\tiny
```{r echo = FALSE, results = "asis"}
texreg(list(ols, wls, sur),
    custom.model.names = c("OLS", "WLS", "SUR"),
    label = "table : ols, wls and sur")
```
\tiny

# Disturbances correlation study 
- Les résidus sont non correlés avec les variables explicatives
```{r include = FALSE}
cordata = dataWX %>% 
    mutate(u1 = ols$eq[[1]]$res,
        u2 = ols$eq[[2]]$res,
        u3 = wls$eq[[1]]$res,
        u4 = wls$eq[[2]]$res,
        u5 = sur$eq[[1]]$res,
        u6 = sur$eq[[2]]$res)
cormat = cor(cordata[,-c(6,7)])[1:5, 6:11]
colnames(cormat) = c("OLS D", "OLS O", 
        "WLS D", "WLS O", 
        "SUR D", "SUR O")
rownames(cormat) = c("Vin", "IP", 
        "Surface", "Revenus", 
        "Pesticides")
```
```{r include = FALSE}
stargazer(cormat, 
    title = "Errors correlation",
    summary = F)
```
\tiny
\begin{table}[!htbp] \centering 
  \caption{Errors correlation} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}} ccccccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & OLS D & OLS O & WLS D & WLS O & SUR D & SUR O \\ 
\hline \\[-1.8ex] 
Vin & $0.232$ & $0.244$ & $0.232$ & $0.244$ & $0.273$ & $0.275$ \\ 
IP & $-0$ & $-0$ & $0$ & $-0$ & $0$ & $0$ \\ 
Surface & $0.271$ & $-0$ & $0.271$ & $0$ & $0.313$ & $0.236$ \\ 
Revenus & $0$ & $-0.480$ & $-0$ & $-0.480$ & $-0.393$ & $-0.542$ \\ 
Pesticides & $-0.308$ & $-0$ & $-0.308$ & $0$ & $-0.373$ & $-0.281$ \\
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

# Les résultats 2SLS, W2SLS et 3SLS
```{r include = FALSE}
# equations
eqdemand = qi ~ 0 + ipi + ri
eqoffer = qi ~ 0 + ipi + si + iki 
inst = ~ ri + si + iki
system = list(Demande = eqdemand, Offre = eqoffer)
# 2SLS
# 2SLS is an equivalent of ILS (indirect least squares)
sls2 = systemfit(system, 
    inst = inst,
    data = dataWX, 
    method = "2SLS")
# 2WSLS
wsls2 = systemfit(system, 
    inst = inst,
    data = dataWX, 
    method = "W2SLS")
# 3SLS (errors correction)
sls3 = systemfit(system, 
    inst = inst,
    data = dataWX, 
    method = "3SLS")
```
\tiny
```{r echo = FALSE, results = "asis"}
texreg(list(sls2, wsls2, sls3),
    custom.model.names = c("2SLS", "W2SLS", "3SLS"),
    label = "table : 2sls, w2sls and 3sls")
```
\tiny

# Model choice tests 
- Hausman 3SLS consistency test :
```{r echo = FALSE, results = "asis"}
hausman.systemfit(sls2, sls3) # p = 1, 3SLS inconsistent
# 2SLS estimator is consistent
```
```{r echo = FALSE, results = "asis"}
# - Linear test :
# What should be tested ???
# linearHypothesis(sls2, 
```
- Likelihood test :
```{r include = FALSE}
lr = lrtest(sls2, wsls2, sls3)
stargazer(lr, summary = FALSE)
```
\tiny
\begin{table}[!htbp] \centering 
\begin{tabular}{@{\extracolsep{5pt}} cccccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \#Df & LogLik & Df & Chisq & Pr(\textgreater Chisq) \\ 
\hline \\[-1.8ex] 
1 & $6$ & $-149.621$ & $$ & $$ & $$ \\ 
2 & $7$ & $-149.621$ & $1$ & $0$ & $1.000$ \\ 
3 & $8$ & $-65.614$ & $1$ & $168.013$ & $0$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

# Residuals tests
- Residuals normality test
```{r include = FALSE}
ShapT = data.frame(nrow = 2, ncol = 6)
ShapT[1,1] = shapiro.test(sls2$eq[[1]]$res)$p.val
ShapT[2,1] = shapiro.test(sls2$eq[[2]]$res)$p.val
ShapT[1,2] = shapiro.test(wsls2$eq[[1]]$res)$p.val
ShapT[2,2] = shapiro.test(wsls2$eq[[2]]$res)$p.val
ShapT[1,3] = shapiro.test(sls3$eq[[1]]$res)$p.val
ShapT[2,3] = shapiro.test(sls3$eq[[2]]$res)$p.val
colnames(ShapT) = c("2SLS", "W2SLS", "3SLS")
rownames(ShapT) = c("Equation de demande", "Equation d'offre")
```
```{r include = FALSE}
stargazer(ShapT,
    summary = FALSE,
    title = "Shapiro-Wilk test")
```
\tiny
\begin{table}[!htbp] \centering 
  \caption{Shapiro-Wilk test} 
\begin{tabular}{@{\extracolsep{5pt}} cccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & 2SLS & W2SLS & 3SLS \\ 
\hline \\[-1.8ex] 
Equation de demande & $0.00003$ & $0.00003$ & $0.00003$ \\ 
Equation d'offre & $0.00000$ & $0.00000$ & $0.00000$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

\normalsize

- Residuals heteroscedasticity test
```{r include = FALSE}
resdata3 = dataWX %>% 
    mutate(u1 = sls2$eq[[1]]$res,
        u2 = sls2$eq[[2]]$res,
        u3 = wsls2$eq[[1]]$res,
        u4 = wsls2$eq[[2]]$res,
        u5 = sls3$eq[[1]]$res,
        u6 = sls3$eq[[2]]$res)
```
```{r echo = FALSE, results = "asis"}
BartT = data.frame(ncol = 3, nrow = 2)
BartT[1,1] = ols_test_bartlett(resdata3, u1, group_var = ndep)$pval
BartT[2,1] = ols_test_bartlett(resdata3, u2, group_var = ndep)$pval
BartT[1,2] = ols_test_bartlett(resdata3, u3, group_var = ndep)$pval
BartT[2,2] = ols_test_bartlett(resdata3, u4, group_var = ndep)$pval
BartT[1,3] = ols_test_bartlett(resdata3, u5, group_var = ndep)$pval
BartT[2,3] = ols_test_bartlett(resdata3, u6, group_var = ndep)$pval
colnames(BartT) = c("2SLS", "W2SLS", "3SLS")
rownames(BartT) = c("Equation de demande", "Equation d'offre")
```
```{r include = FALSE}
stargazer(BartT,
    summary = FALSE,
    title = "Bartlett test")
```
\tiny 
\begin{table}[!htbp] \centering 
  \caption{Bartlett test}
\begin{tabular}{@{\extracolsep{5pt}} cccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & 2SLS & W2SLS & 3SLS \\ 
\hline \\[-1.8ex] 
Equation de demande & $0.975$ & $0.975$ & $0.975$ \\ 
Equation d'offre & $0.0003$ & $0.0003$ & $0.002$ \\ 
\hline \\[-1.8ex] 
\end{tabular}
\end{table} 

# Residuals PDF visualisation
```{r echo = FALSE}
par(mfrow = c(1,2))
plot(density(sls2$eq[[1]]$res), col = "blue", main = "Demande")
lines(density(wsls2$eq[[1]]$res), col = "green")
lines(density(sls3$eq[[1]]$res), col = "red")
plot(density(sls3$eq[[2]]$res), col = "red", main = "Offre")
lines(density(wsls2$eq[[2]]$res), col = "green")
lines(density(sls2$eq[[2]]$res), col = "blue")
```

# Residuals autocorrelation study for 3SLS
```{r echo = FALSE}
par(mfrow = c(1,2))
acf(sls3$eq[[1]]$res, main = "Demande")
acf(sls3$eq[[2]]$res, main = "Offre")
```

# Disturbances correlation study 
- Les résidus sont peux correlés avec les variables explicatives
```{r include = FALSE}
cormat = cor(resdata3[,-c(6,7)])
cormat = cormat[1:5, 6:11]
colnames(cormat) = c("2SLS D", "2SLS O", 
        "W2SLS D", "W2SLS O", 
        "3SLS D", "3SLS O")
rownames(cormat) = c("Vin", "IP", 
        "Surface", "Revenus", 
        "Pesticides")
```
```{r include = FALSE}
stargazer(cormat, 
    title = "Errors correlation",
    summary = F)
```
\tiny
\begin{table}[!htbp] \centering 
  \caption{Errors correlation} 
\begin{tabular}{@{\extracolsep{5pt}} ccccccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & 2SLS D & 2SLS O & W2SLS D & W2SLS O & 3SLS D & 3SLS O \\ 
\hline \\[-1.8ex] 
Vin & $-0.561$ & $0.906$ & $-0.561$ & $0.906$ & $-0.561$ & $0.898$ \\ 
IP & $-0.746$ & $0.948$ & $-0.746$ & $0.948$ & $-0.746$ & $0.938$ \\ 
Surface & $-0.034$ & $0$ & $-0.034$ & $0$ & $-0.034$ & $0.032$ \\ 
Revenus & $0$ & $0$ & $0$ & $0$ & $-0$ & $0$ \\ 
Pesticides & $-0.113$ & $0$ & $-0.113$ & $0$ & $-0.113$ & $0.105$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

# Conclusions 
- Le rôle des pésticides 
- Le marché du vin 
- Validité 
- Limitations 
- Ouverture 

# Bibliographie 
- Cembalo L., Caracciolo F., & Pomarici E. (2014). Drinking cheaply : the demand for basic wine in italy. *Australian Journal of Agricultural and Resource Economics*, 58(3). 374-391.
- Butault J-P., Delame N., Jacquet F. & Zardet G. (2011). L'utilisation des pesticides en France: état des lieux et perspectives de réduction. *Notes et études socio-économiques*, 35. 7-26
- Pujol J. (2017). Apports des produits phytosanitaires en viticulture et climat : une analyse à partir des enquêtes pratiques culturales. *Agreste Les Dossiers*. 39. 3-25